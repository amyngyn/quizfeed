package quiz;

import java.security.*;
import java.sql.*;
import java.util.Random;

public class User {
	private static final int SALT_LENGTH = 20;

	/**
	 * 
	 * @param username
	 * @param passwordText
	 * @return
	 */
	public static boolean addUserToDatabase(String username, String passwordText) {
		String passwordHash = generateSaltedHash(passwordText, null);

		if (passwordHash == null) return false;

		Connection con = null;
		Statement statement = null;
		try {
			con = Database.openConnection();
			statement = Database.getStatement(con);

			//TODO check if user already exists and return false.

		} catch (SQLException e) {
			e.printStackTrace();
		} finally {
			Database.closeConnections(con, statement, null);
		}
		return true;
	}

	public static boolean validateUser(String username, String passwordAttempt) {
		String salt = ""; // TODO get salt from database for this user
		String passwordInDatabase = generateSaltedHash(passwordAttempt, salt);
		return passwordInDatabase.equals(passwordAttempt);
	}

	/**
	 * @param plaintext The text to hash.
	 * @param salt The salt to use. If null, this method will generate a new salt.
	 * @return A String representation of the plaintext bytes hashed with a salt.
	 */
	public static String generateSaltedHash(String plaintext, String salt) {
		if (salt == null)
			salt = generateSalt();

		try {
			MessageDigest md = MessageDigest.getInstance("SHA");
			md.update((plaintext + salt).getBytes());
			byte[] hash = md.digest();
			return hexToString(hash);
		} catch (NoSuchAlgorithmException e) {
			e.printStackTrace();
			return null;
		}
	}

	/**
	 * Randomly generates a String representation of randomly generated bytes.
	 */
	private static String generateSalt() {
		byte[] salt = new byte[SALT_LENGTH];
		new Random().nextBytes(salt);
		return hexToString(salt);
	}

	/**
	 * Given a byte[] array, produces a hex String, such as "234a6f"
	 * with 2 chars for each byte in the array.
	 * (provided code from CS 108 hw4)
	 */ 
	private static String hexToString(byte[] bytes) { 
		StringBuffer buff = new StringBuffer(); 
		for (int i=0; i<bytes.length; i++) { 
			int val = bytes[i]; 
			val = val & 0xff;  // remove higher bits, sign 
			if (val<16) buff.append('0'); // leading 0 
			buff.append(Integer.toString(val, 16)); 
		} 
		return buff.toString(); 
	} 
}
